// ============================================================================
// BigBrother V6 - TradingView Indicator Version
// 4H级别趋势突破策略 (纯指标版，无回测)
// ============================================================================
//@version=5
indicator("BigBrother V6", overlay=true)

// ==================== 输入参数 ====================
// 趋势判断
smlLen = input.int(12, "短期EMA", minval=5, maxval=20, group="趋势参数")
bigLen = input.int(50, "长期EMA", minval=30, maxval=80, group="趋势参数")
breakLen = input.int(30, "突破周期", minval=15, maxval=50, group="趋势参数")

// 指标参数
atrLen = input.int(20, "ATR周期", minval=10, maxval=30, group="指标参数")
adxLen = input.int(14, "ADX周期", minval=10, maxval=20, group="指标参数")
adxThres = input.float(22.0, "ADX阈值", minval=15, maxval=30, group="指标参数")
chopLen = input.int(14, "CHOP周期", minval=10, maxval=20, group="指标参数")
chopThres = input.float(50.0, "CHOP阈值", minval=40, maxval=60, group="指标参数")

// 成交量参数
volLen = input.int(20, "成交量均线", minval=10, maxval=30, group="成交量")
volMulti = input.float(1.3, "成交量倍数", minval=1.0, maxval=2.0, step=0.1, group="成交量")

// 止损参数
stopN = input.float(3.0, "初始止损ATR倍数", minval=2.0, maxval=5.0, step=0.5, group="止损")
minStopN = input.float(2.0, "最小止损ATR倍数", minval=1.0, maxval=3.0, step=0.5, group="止损")

// 止盈参数
breakEvenPct = input.float(10.0, "保本触发%", minval=5, maxval=20, group="止盈") / 100
partialTriggerPct = input.float(12.0, "分批止盈触发%", minval=8, maxval=20, group="止盈") / 100
partialDrawdownPct = input.float(4.0, "分批止盈回撤%", minval=2, maxval=10, group="止盈") / 100
fullDrawdownPct = input.float(8.0, "完全止盈回撤%", minval=5, maxval=15, group="止盈") / 100

// 显示控制
showSignals = input.bool(true, "显示买卖信号", group="显示")
showEMA = input.bool(true, "显示EMA", group="显示")
showStopLine = input.bool(true, "显示止损线", group="显示")

// ==================== 计算指标 ====================
// EMA
maShort = ta.ema(close, smlLen)
maLong = ta.ema(close, bigLen)

// 突破线
highLine = ta.highest(high, breakLen)

// ATR
atr = ta.atr(atrLen)

// ADX (使用内置函数)
[diPlus, diMinus, adxValue] = ta.dmi(adxLen, adxLen)

// CHOP 波动指数
chop = 100 * math.log10(math.sum(ta.atr(1), chopLen) / (ta.highest(high, chopLen) - ta.lowest(low, chopLen))) / math.log10(chopLen)

// 成交量均线
volMA = ta.sma(volume, volLen)

// ==================== 市场状态判断 ====================
isBullish = maShort > maLong
isTrendStrong = adxValue > adxThres
isTrendMarket = chop < chopThres
hasVolConfirm = volume > volMA * volMulti
isBreakout = close > highLine[1]

// ==================== 入场信号 ====================
buySignal = isBullish and isTrendStrong and isTrendMarket and isBreakout and hasVolConfirm

// ==================== 模拟持仓状态追踪 (用于显示止损线等) ====================
var bool inPosition = false
var float entryPrice = na
var float highSince = na
var bool hasPartialExit = false
var float highAfterPartial = na

// 入场逻辑
if buySignal and not inPosition
    inPosition := true
    entryPrice := close
    highSince := high
    hasPartialExit := false
    highAfterPartial := na

// 更新持仓状态
if inPosition
    if na(highSince) or high > highSince
        highSince := high
    if hasPartialExit and (na(highAfterPartial) or high > highAfterPartial)
        highAfterPartial := high

// 计算盈亏指标
profitRate = inPosition ? (close - entryPrice) / entryPrice : 0.0
maxProfitRate = inPosition and not na(highSince) ? (highSince - entryPrice) / entryPrice : 0.0
drawdownFromHigh = inPosition and not na(highSince) and highSince > 0 ? (highSince - close) / highSince : 0.0

// ==================== 动态止损计算 ====================
getDynamicStopN(maxProfit) =>
    if maxProfit < 0.05
        stopN
    else if maxProfit < 0.10
        stopN - (stopN - minStopN) * 0.3
    else if maxProfit < 0.15
        stopN - (stopN - minStopN) * 0.6
    else
        minStopN

dynStopN = getDynamicStopN(maxProfitRate)
stopLine = inPosition and not na(highSince) ? highSince - atr * dynStopN : na

// ==================== 出场条件检测 ====================
// 趋势反转
trendReverse = maShort < maLong

// 分批止盈条件
partialProfitCond = inPosition and not hasPartialExit and maxProfitRate >= partialTriggerPct and drawdownFromHigh >= partialDrawdownPct

// 完全止盈条件
drawdownAfterPartial = hasPartialExit and not na(highAfterPartial) and highAfterPartial > 0 ? (highAfterPartial - close) / highAfterPartial : 0.0
fullProfitCond = inPosition and hasPartialExit and drawdownAfterPartial >= fullDrawdownPct

// 保本止损
breakEvenCond = inPosition and maxProfitRate >= breakEvenPct and profitRate <= 0

// 追踪止损
trailStopCond = inPosition and not na(stopLine) and close < stopLine

// 初始止损
initialStopPrice = inPosition and not na(entryPrice) ? entryPrice - atr * stopN : na
initialStopCond = inPosition and not na(initialStopPrice) and close < initialStopPrice

// ==================== 汇总止盈/止损信号 ====================
// 止盈类出场 (赚钱出场)
isTakeProfit = partialProfitCond or fullProfitCond

// 止损类出场 (亏钱或保本出场)
isStopLoss = trendReverse or trailStopCond or initialStopCond or breakEvenCond

// ==================== 模拟出场状态更新 ====================
// 分批止盈触发
if partialProfitCond
    hasPartialExit := true
    highAfterPartial := close

// 完全出场条件
exitSignal = trendReverse or fullProfitCond or breakEvenCond or trailStopCond or initialStopCond

if exitSignal and inPosition
    inPosition := false
    entryPrice := na
    highSince := na
    hasPartialExit := false
    highAfterPartial := na

// ==================== 绘图 ====================
// EMA
plot(showEMA ? maShort : na, "EMA短", color=color.new(color.blue, 0), linewidth=2)
plot(showEMA ? maLong : na, "EMA长", color=color.new(color.orange, 0), linewidth=2)

// 突破线
plot(highLine[1], "突破线", color=color.new(color.purple, 50), style=plot.style_stepline)

// 止损线
plot(showStopLine and inPosition ? stopLine : na, "止损线", color=color.new(color.red, 0), style=plot.style_linebr, linewidth=2)

// 入场价格
plot(inPosition ? entryPrice : na, "入场价", color=color.new(color.green, 0), style=plot.style_linebr, linewidth=1)

// 保本线
breakEvenLine = inPosition and maxProfitRate >= breakEvenPct ? entryPrice * 1.005 : na
plot(breakEvenLine, "保本线", color=color.new(color.teal, 0), style=plot.style_linebr, linewidth=1)

// ==================== 信号标识 (简洁版) ====================
// 买入信号 - 绿色向上三角 (K线下方)
plotshape(showSignals and buySignal and not inPosition[1], "买入", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.normal)

// 止盈信号 - 绿色向下三角 (K线上方) - 赚钱出场
plotshape(showSignals and isTakeProfit and inPosition[1], "止盈", shape.triangledown, location.abovebar, color.new(color.green, 0), size=size.normal)

// 止损信号 - 红色叉叉 (K线下方) - 亏钱/保本出场
plotshape(showSignals and isStopLoss and inPosition[1] and not isTakeProfit, "止损", shape.xcross, location.belowbar, color.new(color.red, 0), size=size.normal)

// 背景色：显示市场状态
bgcolor(isBullish and isTrendStrong and isTrendMarket ? color.new(color.green, 95) : na, title="趋势市场")

// ==================== 报警条件 ====================
alertcondition(buySignal and not inPosition[1], "买入信号", "BigBrother V6: 买入信号触发")
alertcondition(isTakeProfit and inPosition[1], "止盈出场", "BigBrother V6: 止盈出场")
alertcondition(isStopLoss and inPosition[1], "止损出场", "BigBrother V6: 止损出场")

// ==================== 信息面板 ====================
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "指标", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "数值", text_color=color.white, text_size=size.small)

    table.cell(infoTable, 0, 1, "ADX", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(adxValue, "#.##"), text_color=adxValue > adxThres ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 2, "CHOP", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(chop, "#.##"), text_color=chop < chopThres ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 3, "成交量倍数", text_color=color.white, text_size=size.small)
    volRatio = volMA > 0 ? volume / volMA : 0
    table.cell(infoTable, 1, 3, str.tostring(volRatio, "#.##") + "x", text_color=volRatio > volMulti ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 4, "趋势", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, isBullish ? "↑多头" : "↓空头", text_color=isBullish ? color.green : color.red, text_size=size.small)

    table.cell(infoTable, 0, 5, "模拟持仓", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, inPosition ? str.tostring(profitRate * 100, "#.##") + "%" : "空仓", text_color=profitRate > 0 ? color.green : (inPosition ? color.red : color.gray), text_size=size.small)

    table.cell(infoTable, 0, 6, "最大盈利", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, inPosition ? str.tostring(maxProfitRate * 100, "#.##") + "%" : "-", text_color=color.yellow, text_size=size.small)

    table.cell(infoTable, 0, 7, "止损倍数", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(dynStopN, "#.#") + "x ATR", text_color=color.orange, text_size=size.small)
